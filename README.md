# Система аутентификации и авторизации с использованием JWT и Redis

## Описание задания

Необходимо реализовать систему авторизации и аутетификации с использованием Redis, для реализации белого списка токенов (JWT).

## Описание решения

Реализация системы аутентификации и авторизации с использованием JWT-токенов и Redis для хранения refresh-токенов. Проект предоставляет REST API для регистрации, входа, выхода и доступа к защищенным ресурсам с ролевой моделью доступа.

При переходе по эндпоинту /register/ пользователю необходимо ввести username и дважды ввести пароль, если данный username уже существует в базе данных, возбуждается исключение, в ином случае, если пароли совпадают, username и его захешированный пароль добавляются в базу данных (PostgreSQL) и ему присваивается роль User.

При переходе по эндпоинту /login/ пользователю необходимо передать логин и пароль. Происходит поиск по username в базе данных, если данный пользователь найден и пароли совпадают, то пользователю отправляются access и refresh токены, которые сохраняются в cookie. Так же refresh токен сохраняется в Redis, по ключу username. Access и refresh токены хранят такую информацию как username, role, user_agent(откуда отправляется запрос)

При переходе по эндпоинту /logout/ из cookie удаляются access и refresh токены, так же удаляется refresh токен из Redis.

Так же в проекте реализовано два эндпоита контента /some_resource/ и /some_admin_resource/. Не трудно догадаться, что по первому эндпоинту может проходить любой авторизованный юзер, по второму только юзеры с ролью Admin. 

При попытке перехода по одному из этих эндпоинтов, проверяется валидность access токена, если данный токен истек, проверяется валидности refresh токена, если refresh токен валиден, тогда пользователю назначаются новые access и refresh токены, в случае невалидности access или refresh токена, возбуждается исключение. В случае валидности токенов, проверяется соответсвие роли пользователя со списком ролей, которые могут получать доступ к этому ресурсу.

Для хранения токенов были выбраны cookie, потому что Http-Only куки защищают от XSS атак, а также флаг SameSite защищает от CSRF-атак.

Если все же произошла утечка токена, то в токене так же хранится информация о том, откуда отправляется запрос (user_agent), если данные запроса не совпадают с данными user_agent, которые хранятся в токене, то возбуждается исключение.

## Запуск проекта

### Вариант 1: Запуск проекта локально

1. Создайте файл .env и заполните необходимые данные

2. Установите необходимые зависимости
```pip install -r requirements.txt```

3. Примените миграции
```alembic upgrade head```

4. Запустите сервер Redis
```sudo service redis-server start```

5. Перейти в директорию src и запустить сервер
``` bash
cd src
uvicron main:app --reload
```

### Вариант 2: Запуск проекта в Docker-контейнере 

1. Создайте файл .env и заполните необходимые данные

2. Соберите образ и запустите контейнер
```docker-compose up --build```



